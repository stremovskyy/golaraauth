# Golaraauth 

golaraauth is a simple authentication provider written in GO used in [Laravel](https://laravel.com/) 5.1+.

with this package you can verify the token string that generated by laravel and return the user model that used in laravel auth provider.

## Features

- ✅ JWT token verification with RSA signing
- ✅ Database integration with GORM
- ✅ **Caching support with [cachemar](https://github.com/stremovskyy/cachemar)**
- ✅ Performance optimization through token result caching
- ✅ Backward compatibility (caching is optional)

## Installation

```bash
go get github.com/stremovskyy/golaraauth
```

## Usage

### Basic Usage (Without Caching)

```go
package main

import (
    "github.com/stremovskyy/golaraauth"
)

type DBModel struct {
    ID        int64
    TokenID   string
    CreatedAt string
    UpdatedAt string
}

func main() {
    model := &DBModel{}

    dbConfig := golaraauth.DbConfig{
        HostName:       "127.0.0.1",
        Port:           "3306",
        Username:       "root",
        Password:       "password",
        DbName:         "database",
        TokensTable:    "personal_access_tokens",
        TokensTableCol: "id",
    }

    config := golaraauth.AuthConfig{
        DbConfig:   dbConfig,
        PrivateKey: privKey,
        PublicKey:  pubkey,
    }

    a := golaraauth.LaravelAuthenticator{}
    err := a.New(config)
    if err != nil {
        panic(err)
    }
    defer a.CloseDBConnection()

    valid, err := a.VerifyTokenString(tokenString, model)
    if err != nil {
        panic(err)
    }

    if valid {
        println("Token is valid!")
        println("Token ID:", model.TokenID)
    }
}
```

### Usage with Caching (Recommended for Production)

```go
package main

import (
    "github.com/stremovskyy/cachemar"
    "github.com/stremovskyy/cachemar/drivers/memory"
    "github.com/stremovskyy/golaraauth"
)

func main() {
    // Create cache manager
    manager := cachemar.New()
    memoryCache := memory.NewWithConfig(memory.Config{MaxSize: 1000})
    manager.Register("memory", memoryCache)
    manager.SetCurrent("memory")

    // Configure authenticator with cache
    config := golaraauth.AuthConfig{
        DbConfig:   dbConfig,
        PrivateKey: privKey,
        PublicKey:  pubkey,
        Cache:      manager.Current(), // Add cache instance
    }

    authenticator := golaraauth.LaravelAuthenticator{}
    err := authenticator.New(config)
    if err != nil {
        panic(err)
    }
    defer authenticator.CloseDBConnection()

    model := &DBModel{}
    valid, err := authenticator.VerifyTokenString(tokenString, model)
    if err != nil {
        panic(err)
    }

    // Subsequent calls will use cache for better performance
    // ...

    // Clear specific token from cache when needed (e.g., token revoked)
    authenticator.ClearTokenFromCache(tokenString)

    // Clear all token cache
    authenticator.ClearAllTokenCache()
}
```

## Caching Benefits

When caching is enabled:

- ✅ **Performance**: Significant performance improvement for repeated token verifications
- ✅ **Database Load**: Reduces database queries for frequently verified tokens  
- ✅ **Scalability**: Better application scalability under high load
- ✅ **Configurable TTL**: Valid tokens cached for 15 minutes, invalid tokens for 5 minutes
- ✅ **Cache Management**: Methods to clear specific tokens or all cached data

### Cache Drivers Supported

Thanks to [cachemar](https://github.com/stremovskyy/cachemar), you can use:

- **Memory** (in-process, with optional LRU eviction)
- **Redis** (single instance or cluster)
- **Memcached**

## Configuration Options

### AuthConfig

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `DbConfig` | `DbConfig` | ✅ | Database configuration |
| `PrivateKey` | `string` | ✅* | Base64 encoded RSA private key |
| `PublicKey` | `string` | ✅* | Base64 encoded RSA public key |
| `PrivateKeyFile` | `string` | ✅* | Path to RSA private key file |
| `PublicKeyFile` | `string` | ✅* | Path to RSA public key file |
| `Cache` | `cachemar.Cacher` | ❌ | Optional cache instance |

*Either provide key strings OR key files

### DbConfig

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `HostName` | `string` | ✅ | Database host |
| `Port` | `string` | ✅ | Database port |
| `Username` | `string` | ✅ | Database username |
| `Password` | `string` | ✅ | Database password |
| `DbName` | `string` | ✅ | Database name |
| `TokensTable` | `string` | ✅ | Table containing tokens |
| `TokensTableCol` | `string` | ✅ | Column name for token ID |

## Cache Management Methods

```go
// Clear specific token from cache (useful when token is revoked)
err := authenticator.ClearTokenFromCache(tokenString)

// Clear all cached token data (useful for cache refresh)
err := authenticator.ClearAllTokenCache()
```

## Examples

See the `example/` directory for complete working examples:

- `example/from_strings/` - Basic usage with hardcoded keys
- `example/with_keys/` - Basic usage with key files  
- `example/with_cache/` - **Advanced usage with caching enabled**

## Performance

Caching can provide significant performance improvements:

- **Without cache**: Every verification requires JWT parsing + database query
- **With cache**: Subsequent verifications for the same token are served from memory
- **Typical improvement**: 60-90% faster response times for cached tokens

## License

[MIT](https://choosealicense.com/licenses/mit/)

## Contributing

Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.

Please make sure to update tests as appropriate.

## Authors

* **Anton Stremovskyy** - *Initial work* - [stremovskyy](https://github.com/stremovskyy)

## Acknowledgements

- [Laravel](https://laravel.com/)
- [jwt-go](https://github.com/golang-jwt/jwt)  
- [gorm](https://gorm.io/gorm)
- [cachemar](https://github.com/stremovskyy/cachemar)
